name: $(Date:yyyyMMdd)$(Rev:.r)-Infrastructure
trigger: none
pr: none

pool:
  name: Yousif-Agent_Pool

parameters:
  - name: env
    displayName: Environment
    type: string
    default: nonprod
    values: [nonprod, prod]

  - name: action
    displayName: Action
    type: string
    default: plan
    values: [plan, apply, destroy]

variables:
  TF_DIR: 'terraform'
  TF_VAR_FILE: '${{ parameters.env }}.tfvars'
  AWS_SERVICE_CONNECTION: 'yousif-aws-v2'
  AWS_REGION: 'ap-northeast-2'
  TF_IN_AUTOMATION: 'true'

  TF_BACKEND_BUCKET: 'yousif-project-bucket'
  TF_BACKEND_KEY: '${{ parameters.env }}/terraform.tfstate'

stages:
- stage: Validate
  displayName: 'Validate Terraform'
  jobs:
  - job: Validate
    steps:
    - checkout: self

    - task: TerraformInstaller@1
      displayName: Install Terraform
      inputs:
        terraformVersion: latest

    - task: AWSShellScript@1
      displayName: Terraform fmt / validate
      inputs:
        awsCredentials: $(AWS_SERVICE_CONNECTION)
        regionName: $(AWS_REGION)
        scriptType: inline
        inlineScript: |
          set -euo pipefail
          cd "$(TF_DIR)"

          echo "==> terraform fmt -check"
          terraform fmt -check -recursive

          echo "==> terraform init (S3 backend only)"
          terraform init -reconfigure \
            -backend-config="bucket=$(TF_BACKEND_BUCKET)" \
            -backend-config="key=$(TF_BACKEND_KEY)" \
            -backend-config="region=$(AWS_REGION)" \
            -backend-config="encrypt=true"

          echo "==> terraform validate"
          terraform validate

- stage: Plan
  displayName: 'Terraform Plan'
  dependsOn: Validate
  condition: succeeded()
  jobs:
  - job: Plan
    steps:
    - checkout: self

    - task: TerraformInstaller@1
      displayName: Install Terraform
      inputs:
        terraformVersion: latest

    - task: AWSShellScript@1
      displayName: Terraform init + plan
      inputs:
        awsCredentials: $(AWS_SERVICE_CONNECTION)
        regionName: $(AWS_REGION)
        scriptType: inline
        inlineScript: |
          set -euo pipefail
          cd "$(TF_DIR)"

          terraform init -reconfigure \
            -backend-config="bucket=$(TF_BACKEND_BUCKET)" \
            -backend-config="key=$(TF_BACKEND_KEY)" \
            -backend-config="region=$(AWS_REGION)" \
            -backend-config="encrypt=true"

          mkdir -p "$(Build.ArtifactStagingDirectory)/tfplan"

          echo "==> terraform plan"
          terraform plan -var-file="$(TF_VAR_FILE)" -out="$(Build.ArtifactStagingDirectory)/tfplan/tfplan"

          echo "==> save readable plan"
          terraform show -no-color "$(Build.ArtifactStagingDirectory)/tfplan/tfplan" > "$(Build.ArtifactStagingDirectory)/tfplan/tfplan.txt"

    - publish: $(Build.ArtifactStagingDirectory)/tfplan
      displayName: 'Publish tfplan artifact'
      artifact: tfplan

- stage: Apply
  displayName: 'Terraform Apply'
  dependsOn: Plan
  condition: and(succeeded(), eq('${{ parameters.action }}', 'apply'))
  jobs:
  - job: Apply
    displayName: Apply Infra
    steps:
    - checkout: self

    - download: current
      artifact: tfplan

    - task: TerraformInstaller@1
      displayName: Install Terraform
      inputs:
        terraformVersion: latest

    - task: AWSShellScript@1
      displayName: Terraform init + apply (from plan)
      inputs:
        awsCredentials: $(AWS_SERVICE_CONNECTION)
        regionName: $(AWS_REGION)
        scriptType: inline
        inlineScript: |
          set -euo pipefail
          cd "$(TF_DIR)"

          terraform init -reconfigure \
            -backend-config="bucket=$(TF_BACKEND_BUCKET)" \
            -backend-config="key=$(TF_BACKEND_KEY)" \
            -backend-config="region=$(AWS_REGION)" \
            -backend-config="encrypt=true"

          echo "==> terraform apply using plan artifact"
          terraform apply -auto-approve "$(Pipeline.Workspace)/tfplan/tfplan"

          echo "==> export outputs"
          terraform output -json > outputs.json

    - publish: $(TF_DIR)/outputs.json
      displayName: 'Publish outputs.json'
      artifact: tf_outputs

- stage: Destroy
  displayName: 'Terraform Destroy'
  dependsOn: Validate
  condition: and(succeeded(), eq('${{ parameters.action }}', 'destroy'))
  jobs:
  - job: Destroy
    displayName: Destroy Infra
    steps:
    - checkout: self

    - task: TerraformInstaller@1
      displayName: Install Terraform
      inputs:
        terraformVersion: latest

    - task: AWSShellScript@1
      displayName: Terraform init + destroy
      inputs:
        awsCredentials: $(AWS_SERVICE_CONNECTION)
        regionName: $(AWS_REGION)
        scriptType: inline
        inlineScript: |
          set -euo pipefail
          cd "$(TF_DIR)"

          terraform init -reconfigure \
            -backend-config="bucket=$(TF_BACKEND_BUCKET)" \
            -backend-config="key=$(TF_BACKEND_KEY)" \
            -backend-config="region=$(AWS_REGION)" \
            -backend-config="encrypt=true"

          echo "==> terraform destroy"
          terraform destroy -auto-approve -var-file="$(TF_VAR_FILE)"